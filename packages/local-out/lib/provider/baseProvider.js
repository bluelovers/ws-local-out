"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const cross_spawn_extra_1 = require("cross-spawn-extra");
const bluebird_1 = __importDefault(require("bluebird"));
const AbstractProvider_1 = require("../AbstractProvider");
class BaseProvider extends AbstractProvider_1.AbstractProvider {
    _constructor() {
        super._constructor();
        this._cache = {
            SERVICES: ["ssh.localhost.run", "serveo.net"],
            SERVICES_CONTAINS: ["Connect to", "Forwarding HTTP traffic from"],
            ID_SERVICES: 0,
        };
    }
    connect() {
        const { context } = this;
        if (context.port == null) {
            throw new TypeError("port is undefined");
        }
        let ID_SERVICES = this._cache.ID_SERVICES;
        let fn = (e) => {
            context.debug && context._debugConsole.debug(`[connect]`, e.message.replace(/\s+$/g, ''));
            if (this._provider(++ID_SERVICES)) {
                return this._exec(ID_SERVICES)
                    // @ts-ignore
                    .then(fn);
            }
            else if (e.message.includes('timeout')) {
                e = new Error("All of the services to forwards PORT is off.");
            }
            return bluebird_1.default.reject(e);
        };
        return this._exec(ID_SERVICES)
            .catch(fn);
    }
    _provider(ID_SERVICES) {
        return this._cache.SERVICES[ID_SERVICES];
    }
    _ssh_args(ID_SERVICES) {
        let provider = this._provider(ID_SERVICES);
        const args = [
            '-o',
            'StrictHostKeyChecking=no',
            '-o',
            'UserKnownHostsFile=/dev/null',
            '-R',
            `${this.context.portOnline}:${this.context.hostname}:${this.context.port}`,
            provider,
        ];
        return args;
    }
    _exec(ID_SERVICES) {
        const context = this.context;
        let args = this._ssh_args(ID_SERVICES);
        context.debug && context._debugConsole.debug(`[spawn]`, 'ssh', args);
        const ret = cross_spawn_extra_1.async('ssh', args);
        const { child } = ret;
        this.child = child;
        let urlFinded;
        return new bluebird_1.default(((resolve, reject) => {
            child.stderrStream.on('data', (buf) => {
                //this.context.emit(EnumLocalOutEvent.Connect, buf);
                context.debug && context._debugConsole.debug(`[stderr]`, buf.toString().replace(/\s+$/g, ''));
            });
            child
                .stdoutStream
                .on('data', (buf) => {
                context.debug && context._debugConsole.debug(`[stdout]`, buf.toString().replace(/\s+$/g, ''));
                if (urlFinded) {
                    return;
                }
                const data = Buffer.from(buf).toString();
                let SERVICES_CONTAINS = this._cache.SERVICES_CONTAINS[ID_SERVICES];
                if (data.includes(SERVICES_CONTAINS)) {
                    let urlGet = data.split(SERVICES_CONTAINS)[1];
                    let url = replaceAll(urlGet, "\n", "")
                        .trim()
                        .replace(/\s.+$/, '');
                    urlFinded = true;
                    let { hostname, port } = new URL(url);
                    resolve({
                        hostname, port,
                    });
                }
                else {
                    reject(new Error("Can't forward http traffic."));
                }
            });
            setTimeout(r => {
                if (!urlFinded) {
                    reject(new Error("timeout 5s"));
                }
            }, 5000);
        }))
            .tapCatch(e => {
            try {
                child.kill();
            }
            catch (e) {
            }
        });
    }
}
exports.BaseProvider = BaseProvider;
BaseProvider.desc = `localhost.run and serveo provider`;
function replaceAll(str, replaceWhat, replaceTo) {
    replaceWhat = replaceWhat.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
    let re = new RegExp(replaceWhat, 'g');
    return str
        .replace(re, replaceTo);
}
exports.default = BaseProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZVByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFzZVByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBSUEseURBQW1EO0FBQ25ELHdEQUFnQztBQUNoQywwREFBNkU7QUFFN0UsTUFBYSxZQUFhLFNBQVEsbUNBQWdCO0lBVXZDLFlBQVk7UUFFckIsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRXJCLElBQUksQ0FBQyxNQUFNLEdBQUc7WUFDYixRQUFRLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxZQUFZLENBQUM7WUFDN0MsaUJBQWlCLEVBQUUsQ0FBQyxZQUFZLEVBQUUsOEJBQThCLENBQUM7WUFDakUsV0FBVyxFQUFFLENBQUM7U0FDZCxDQUFBO0lBQ0YsQ0FBQztJQUVELE9BQU87UUFFTixNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksT0FBTyxDQUFDLElBQUksSUFBSSxJQUFJLEVBQ3hCO1lBQ0MsTUFBTSxJQUFJLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1NBQ3pDO1FBRUQsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFFMUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFRLEVBQWtDLEVBQUU7WUFFckQsT0FBTyxDQUFDLEtBQUssSUFBSSxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFFMUYsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsV0FBVyxDQUFDLEVBQ2pDO2dCQUNDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7b0JBQzdCLGFBQWE7cUJBQ1osSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUNSO2FBQ0Y7aUJBQ0ksSUFBSSxDQUFDLENBQUMsT0FBTyxD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LFNBQVMsQ0FBQyxDQUN0QjtBQUNILENBQUM7QUFFRCxrQkFBZSxZQUFZLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMDE5LzEyLzE0LlxuICovXG5pbXBvcnQgTG9jYWxPdXQsIHsgRW51bUxvY2FsT3V0RXZlbnQgfSBmcm9tICcuLi9pbmRleCc7XG5pbXBvcnQgeyBhc3luYyBhcyBzcGF3biB9IGZyb20gJ2Nyb3NzLXNwYXduLWV4dHJhJztcbmltcG9ydCBCbHVlYmlyZCBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBBYnN0cmFjdFByb3ZpZGVyLCBJUHJvdmlkZXJDb25uZWN0RGF0YSB9IGZyb20gJy4uL0Fic3RyYWN0UHJvdmlkZXInO1xuXG5leHBvcnQgY2xhc3MgQmFzZVByb3ZpZGVyIGV4dGVuZHMgQWJzdHJhY3RQcm92aWRlclxue1xuXHRzdGF0aWMgZGVzYyA9IGBsb2NhbGhvc3QucnVuIGFuZCBzZXJ2ZW8gcHJvdmlkZXJgO1xuXG5cdHByb3RlY3RlZCBfY2FjaGU6IHtcblx0XHRTRVJWSUNFUzogc3RyaW5nW107XG5cdFx0U0VSVklDRVNfQ09OVEFJTlM6IHN0cmluZ1tdO1xuXHRcdElEX1NFUlZJQ0VTOiBudW1iZXI7XG5cdH07XG5cblx0cHJvdGVjdGVkIF9jb25zdHJ1Y3RvcigpXG5cdHtcblx0XHRzdXBlci5fY29uc3RydWN0b3IoKTtcblxuXHRcdHRoaXMuX2NhY2hlID0ge1xuXHRcdFx0U0VSVklDRVM6IFtcInNzaC5sb2NhbGhvc3QucnVuXCIsIFwic2VydmVvLm5ldFwiXSxcblx0XHRcdFNFUlZJQ0VTX0NPTlRBSU5TOiBbXCJDb25uZWN0IHRvXCIsIFwiRm9yd2FyZGluZyBIVFRQIHRyYWZmaWMgZnJvbVwiXSxcblx0XHRcdElEX1NFUlZJQ0VTOiAwLFxuXHRcdH1cblx0fVxuXG5cdGNvbm5lY3QoKVxuXHR7XG5cdFx0Y29uc3QgeyBjb250ZXh0IH0gPSB0aGlzO1xuXHRcdGlmIChjb250ZXh0LnBvcnQgPT0gbnVsbClcblx0XHR7XG5cdFx0XHR0aHJvdyBuZXcgVHlwZUVycm9yKFwicG9ydCBpcyB1bmRlZmluZWRcIik7XG5cdFx0fVxuXG5cdFx0bGV0IElEX1NFUlZJQ0VTID0gdGhpcy5fY2FjaGUuSURfU0VSVklDRVM7XG5cblx0XHRsZXQgZm4gPSAoZTogRXJyb3IpOiBCbHVlYmlyZDxJUHJvdmlkZXJDb25uZWN0RGF0YT4gPT5cblx0XHR7XG5cdFx0XHRjb250ZXh0LmRlYnVnICYmIGNvbnRleHQuX2RlYnVnQ29uc29sZS5kZWJ1ZyhgW2Nvbm5lY3RdYCwgZS5tZXNzYWdlLnJlcGxhY2UoL1xccyskL2csICcnKSk7XG5cblx0XHRcdGlmICh0aGlzLl9wcm92aWRlcigrK0lEX1NFUlZJQ0VTKSlcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuIHRoaXMuX2V4ZWMoSURfU0VSVklDRVMpXG5cdFx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRcdC50aGVuKGZuKVxuXHRcdFx0XHRcdDtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKGUubWVzc2FnZS5pbmNsdWRlcygndGltZW91dCcpKVxuXHRcdFx0e1xuXHRcdFx0XHRlID0gbmV3IEVycm9yKFwiQWxsIG9mIHRoZSBzZXJ2aWNlcyB0byBmb3J3YXJkcyBQT1JUIGlzIG9mZi5cIilcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIEJsdWViaXJkLnJlamVjdChlKTtcblx0XHR9O1xuXG5cdFx0cmV0dXJuIHRoaXMuX2V4ZWMoSURfU0VSVklDRVMpXG5cdFx0XHQuY2F0Y2goZm4pXG5cdFx0XHQ7XG5cdH1cblxuXHRwcm90ZWN0ZWQgX3Byb3ZpZGVyKElEX1NFUlZJQ0VTOiBudW1iZXIpXG5cdHtcblx0XHRyZXR1cm4gdGhpcy5fY2FjaGUuU0VSVklDRVNbSURfU0VSVklDRVNdO1xuXHR9XG5cblx0cHJvdGVjdGVkIF9zc2hfYXJncyhJRF9TRVJWSUNFUzogbnVtYmVyKVxuXHR7XG5cdFx0bGV0IHByb3ZpZGVyID0gdGhpcy5fcHJvdmlkZXIoSURfU0VSVklDRVMpO1xuXG5cdFx0Y29uc3QgYXJncyA9IFtcblx0XHRcdCctbycsXG5cdFx0XHQnU3RyaWN0SG9zdEtleUNoZWNraW5nPW5vJyxcblx0XHRcdCctbycsXG5cdFx0XHQnVXNlcktub3duSG9zdHNGaWxlPS9kZXYvbnVsbCcsXG5cdFx0XHQnLVInLFxuXHRcdFx0YCR7dGhpcy5jb250ZXh0LnBvcnRPbmxpbmV9OiR7dGhpcy5jb250ZXh0Lmhvc3RuYW1lfToke3RoaXMuY29udGV4dC5wb3J0fWAsXG5cdFx0XHRwcm92aWRlcixcblx0XHRdO1xuXG5cdFx0cmV0dXJuIGFyZ3M7XG5cdH1cblxuXHRwcm90ZWN0ZWQgX2V4ZWMoSURfU0VSVklDRVM6IG51bWJlcilcblx0e1xuXHRcdGNvbnN0IGNvbnRleHQgPSB0aGlzLmNvbnRleHQ7XG5cblx0XHRsZXQgYXJncyA9IHRoaXMuX3NzaF9hcmdzKElEX1NFUlZJQ0VTKTtcblxuXHRcdGNvbnRleHQuZGVidWcgJiYgY29udGV4dC5fZGVidWdDb25zb2xlLmRlYnVnKGBbc3Bhd25dYCwgJ3NzaCcsIGFyZ3MpO1xuXG5cdFx0Y29uc3QgcmV0ID0gc3Bhd24oJ3NzaCcsIGFyZ3MpO1xuXG5cdFx0Y29uc3QgeyBjaGlsZCB9ID0gcmV0O1xuXG5cdFx0dGhpcy5jaGlsZCA9IGNoaWxkO1xuXG5cdFx0bGV0IHVybEZpbmRlZDogYm9vbGVhbjtcblxuXHRcdHJldHVybiBuZXcgQmx1ZWJpcmQ8SVByb3ZpZGVyQ29ubmVjdERhdGE+KCgocmVzb2x2ZSwgcmVqZWN0KSA9PlxuXHRcdHtcblx0XHRcdGNoaWxkLnN0ZGVyclN0cmVhbS5vbignZGF0YScsIChidWYpID0+IHtcblx0XHRcdFx0Ly90aGlzLmNvbnRleHQuZW1pdChFbnVtTG9jYWxPdXRFdmVudC5Db25uZWN0LCBidWYpO1xuXG5cdFx0XHRcdGNvbnRleHQuZGVidWcgJiYgY29udGV4dC5fZGVidWdDb25zb2xlLmRlYnVnKGBbc3RkZXJyXWAsIGJ1Zi50b1N0cmluZygpLnJlcGxhY2UoL1xccyskL2csICcnKSk7XG5cblx0XHRcdH0pO1xuXG5cdFx0XHRjaGlsZFxuXHRcdFx0XHQuc3Rkb3V0U3RyZWFtXG5cdFx0XHRcdC5vbignZGF0YScsIChidWYpID0+XG5cdFx0XHRcdHtcblx0XHRcdFx0XHRjb250ZXh0LmRlYnVnICYmIGNvbnRleHQuX2RlYnVnQ29uc29sZS5kZWJ1ZyhgW3N0ZG91dF1gLCBidWYudG9TdHJpbmcoKS5yZXBsYWNlKC9cXHMrJC9nLCAnJykpO1xuXG5cdFx0XHRcdFx0aWYgKHVybEZpbmRlZClcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0Y29uc3QgZGF0YSA9IEJ1ZmZlci5mcm9tKGJ1ZikudG9TdHJpbmcoKTtcblxuXHRcdFx0XHRcdGxldCBTRVJWSUNFU19DT05UQUlOUyA9IHRoaXMuX2NhY2hlLlNFUlZJQ0VTX0NPTlRBSU5TW0lEX1NFUlZJQ0VTXTtcblxuXHRcdFx0XHRcdGlmIChkYXRhLmluY2x1ZGVzKFNFUlZJQ0VTX0NPTlRBSU5TKSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRsZXQgdXJsR2V0ID0gZGF0YS5zcGxpdChTRVJWSUNFU19DT05UQUlOUylbMV07XG5cdFx0XHRcdFx0XHRsZXQgdXJsID0gcmVwbGFjZUFsbCh1cmxHZXQsIFwiXFxuXCIsIFwiXCIpXG5cdFx0XHRcdFx0XHRcdC50cmltKClcblx0XHRcdFx0XHRcdFx0LnJlcGxhY2UoL1xccy4rJC8sICcnKVxuXHRcdFx0XHRcdFx0O1xuXG5cdFx0XHRcdFx0XHR1cmxGaW5kZWQgPSB0cnVlO1xuXG5cdFx0XHRcdFx0XHRsZXQgeyBob3N0bmFtZSwgcG9ydCB9ID0gbmV3IFVSTCh1cmwpO1xuXG5cdFx0XHRcdFx0XHRyZXNvbHZlKHtcblx0XHRcdFx0XHRcdFx0aG9zdG5hbWUsIHBvcnQsXG5cdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHJlamVjdChuZXcgRXJyb3IoXCJDYW4ndCBmb3J3YXJkIGh0dHAgdHJhZmZpYy5cIikpXG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdH0pXG5cdFx0XHQ7XG5cblx0XHRcdHNldFRpbWVvdXQociA9PlxuXHRcdFx0e1xuXG5cdFx0XHRcdGlmICghdXJsRmluZGVkKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0cmVqZWN0KG5ldyBFcnJvcihcInRpbWVvdXQgNXNcIikpXG5cdFx0XHRcdH1cblxuXHRcdFx0fSwgNTAwMCk7XG5cblx0XHR9KSlcblx0XHRcdC50YXBDYXRjaChlID0+XG5cdFx0XHR7XG5cdFx0XHRcdHRyeVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y2hpbGQua2lsbCgpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGNhdGNoIChlKVxuXHRcdFx0XHR7XG5cblx0XHRcdFx0fVxuXHRcdFx0fSlcblx0XHRcdDtcblx0fVxufVxuXG5mdW5jdGlvbiByZXBsYWNlQWxsKHN0cjogc3RyaW5nLCByZXBsYWNlV2hhdDogc3RyaW5nLCByZXBsYWNlVG86IHN0cmluZylcbntcblx0cmVwbGFjZVdoYXQgPSByZXBsYWNlV2hhdC5yZXBsYWNlKC9bLVxcL1xcXFxeJCorPy4oKXxbXFxde31dL2csICdcXFxcJCYnKTtcblx0bGV0IHJlID0gbmV3IFJlZ0V4cChyZXBsYWNlV2hhdCwgJ2cnKTtcblx0cmV0dXJuIHN0clxuXHRcdC5yZXBsYWNlKHJlLCByZXBsYWNlVG8pXG5cdFx0O1xufVxuXG5leHBvcnQgZGVmYXVsdCBCYXNlUHJvdmlkZXJcbiJdfQ==